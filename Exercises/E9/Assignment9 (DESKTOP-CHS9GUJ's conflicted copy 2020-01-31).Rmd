---
title: "BDA - Assignment 9"
author: "Anonymous"
output: pdf_document
---

```{r setup, include=FALSE}
# This chunk just sets echo = TRUE as default (i.e. print all code)
knitr::opts_chunk$set(echo = TRUE)
```
```{r}

library(tidyr) 
library(rstan) 
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
library(loo)
library(ggplot2)
library(gridExtra)
library(bayesplot)
theme_set(bayesplot::theme_default(base_family = "sans"))
library(shinystan)
source('stan_utility.R')
library(aaltobda)
SEED <- 48927 # set random seed for reproducability
```




```{r}
data("factory")
```

The data applied to the hierarchical model is: 
```{r}
data_vec <-list(N = ncol(factory) * nrow(factory),
                     K = ncol(factory) + 1, # +1 is for the posterior predictive for the 7th machine
                     x = rep(1:ncol(factory), nrow(factory)),
                     y = c(t(factory)))

```

## Hierarchical model 

In this model the means of the different machines are assumed to have a common standard deviation $\sigma$ and means $\mu$ that are drawn from a normal distribution with $\mu_0$ and $\sigma_0$. I assumed weekly informative priors for $\mu_0$ and $\sigma_0$ and $\sigma$. The
Stan implementation of the model is as follows:

```{r}
writeLines(readLines("hierarchical.stan"))
```

We fit the separate model in stan as follow: 
```{r}  
fit_hierarchical <- stan(file="hierarchical.stan", data = data_vec, seed = SEED)
```
\textbf{Problem 1: For each of the six machines, compute and report the expected utility of one product of that machine.} 

For the utility function:
- each machine cost is 106 e
- if quality above 85, then the customers pay 200 e, otherwise the prouct is not sold.

The following function computes the expected utility of one product of each machine given the measurements:
```{r}
utility <-function(draws) {
  n <- length(draws) 
  utility <- sum((draws>=85)*200) / n - 106
  return(utility)
}
#TEST:
y_pred <- c(123.80, 85.23, 70.16, 80.57, 84.91)
print('expected utility of the test example')
print(utility(y_pred))

```

Now the posterior predictive data from each machine can be extracted to compute the utility:

```{r}

df = extract(fit_hierarchical)


Util = c()
for(i in 1:6){
  print(sprintf('Expected utility for machine %d:',i))
  Util[i] <- utility(df$ypred[,i])
  print(Util[i])
}

```

\textbf{Problem 2: Rank the machines based on the expected utilities.}
```{r}
order(Util)
```

A positive utility means that we expect the machine to be profitable, i.e. it can be operated without losswhen taking all costs into consideration. Of the six machins, #1 is the only one which is not profitable. The other machines are beneficial for the compaby. The ranking:
Worst => 1, 6, 3, 5, 2, 4 <= Best 


# Question 3: Compute and report the expected utility of the products of a new (7th) machine.

For the 7th machine we need to use the posterior predictive of the new machine computed in the Stan code:
```{r}
Utility_7 = utility(df$ypred[,7])
print('Expected utility for machine 7:')
print(Utility_7)
```



# Question 4:Based on your analysis, discuss briefly whether the company owner should buy a new (7th) machine.

The 7th machine is expected to be profitable so I would advise the business owner to invest if a) he seesgrowth in demand and b) he has access to financing.

