---
title: "BDA - Assignment 9"
author: "Anonymous"
output: pdf_document
---

```{r setup, include=FALSE}
# This chunk just sets echo = TRUE as default (i.e. print all code)
knitr::opts_chunk$set(echo = TRUE)
```
```{r}

library(tidyr) 
library(rstan) 
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
library(loo)
library(ggplot2)
library(gridExtra)
library(bayesplot)
theme_set(bayesplot::theme_default(base_family = "sans"))
library(shinystan)
source('stan_utility.R')
library(aaltobda)
SEED <- 48927 # set random seed for reproducability
```




```{r}
data("factory")
```

The data applied to the hierarchical model is: 
```{r}
data_vec <-list(N = ncol(factory) * nrow(factory),
                     K = ncol(factory) + 1, # +1 is for the posterior predictive for the 7th machine
                     x = rep(1:ncol(factory), nrow(factory)),
                     y = c(t(factory)))

```

## Hierarchical model 

In this model the means of the different machines are assumed to have a common standard deviation $\sigma$ and means $\mu$ that are drawn from a normal distribution with $\mu_0$ and $\sigma_0$. I assumed weekly informative priors for $\mu_0$ and $\sigma_0$ and $\sigma$. The
Stan implementation of the model is as follows:

```{r}
writeLines(readLines("hierarchical.stan"))
```

We fit the separate model in stan as follow: 
```{r}  
fit_hierarchical <- stan(file="hierarchical.stan", data = data_vec, seed = SEED)
```
\textbf{Problem 1: For each of the six machines, compute and report the expected utility of one product of that machine.} 

For the utility function:
- each machine cost is 106 e
- if quality above 85, then the customers pay 200 e, otherwise the prouct is not sold.

The following function computes the expected utility of one product of each machine given the measurements:
```{r}
Utility <- function(draws = y_pred) {
  total_profit = 0
  for(i in 1:length(draws)){
    #remove the cost of building from the profit
    total_profit = total_profit - 106
    #add the profit if quality is higher than a threshold
    if(draws[i] > 85)
      total_profit = total_profit + 200
  }
  #divide the total profit to the number of items
  return(total_profit/length(draws)) 
}

#TEST:
y_pred <- c(123.80, 85.23, 70.16, 80.57, 84.91)
print('expected utility of the test example')
print(Utility(y_pred))
```

Now the posterior predictive data from each machine can be extracted to compute the utility:

```{r}
sample_hierarchical <- rstan::extract(fit_hierarchical)

utility = c()
for(i in 1:6){
  print(sprintf('Expected utility for machine %d:',i))
  utility[i] = Utility(sample_hierarchical$ypred[,i])
  print(utility[i])
}

```

\textbf{Problem 2: Rank the machines based on the expected utilities.}
```{r}
order(utility)
```
Machine 1 is teh worst based on the utility value calculated in the previous problem. Expected utility for machine 1 is -52.45 that means this machine not only is not profitable, but also due to the negative expected utilty the company needs to pay more than what it can earn by selling.
The other machine which is not profitable is machine 6. 

For all other machines except 1 and 6, the average profit is above zero, meaning that the company will earn more than the cost (on average of course), i.e., on average profitable. Out of these, the best one is machine number 4 which gives us an average 82.9 e profit, which is quite good. This also means that on average many of the qualities for this machine are above 85 so that are able to sell many of these. Of course, we cannot sell all products from this machine since the expected utility is still bellow 94 (which is 200-106 indicating the maximum profit).

# Question 3: Compute and report the expected utility of the products of a new (7th) machine.

For the 7th machine we need to use the posterior predictive of the new machine computed in the Stan code:
```{r}
utility_7 = Utility(sample_hierarchical$ypred[,7])
print('Expected utility for machine 7:')
print(utility_7)
```

The expected utility for machine 7 is -67.5 which shows that this machine would not be profitable.

# Question 4:Based on your analysis, discuss briefly whether the company owner should buy a new (7th) machine.

As the expected utility is less than 0, it is not profitable on average to buy a new machine.
